<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>si'se: After-Care Report Generator</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- html2canvas (Screenshot Library) -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Configuration & Styles -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Zen Kaku Gothic New"', 'sans-serif'],
                    },
                    colors: {
                        // Gentle Green Palette (Sage/Nature inspired)
                        brand: {
                            50: '#f2f8f5',   // Very light wash
                            100: '#e1efe7',  // Pale mint
                            200: '#c5e0d1',  // Soft green
                            300: '#9cc7b1',  // Muted green
                            500: '#6ca88a',  // Main "Gentle Green"
                            600: '#52856d',  // Darker Text
                            800: '#345244',  // Deep Forest
                            accent: '#94a3b8',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f0fdf4; /* Very pale green background */
        }
        /* Custom scrollbar for the panel */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #c5e0d1; /* brand-200 */
            border-radius: 3px;
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #9cc7b1; /* brand-300 */
        }
        
        /* Chart Container Strategy */
        .chart-wrapper {
            position: relative;
            width: 100%;
            height: 250px; /* Fixed height for consistency */
            display: flex;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body class="text-gray-700 h-screen overflow-hidden flex flex-col font-sans">

    <!-- Chosen Palette: Gentle Green (Sage/Nature) for healing and calm. -->

    <!-- ========================================== -->
    <!-- MOBILE TABS (Visible only on small screens) -->
    <!-- ========================================== -->
    <div class="md:hidden flex bg-white border-b border-brand-200 z-50 shrink-0 shadow-sm">
        <button onclick="switchTab('edit')" id="tab-edit" class="flex-1 py-3 text-sm font-bold text-brand-600 border-b-4 border-brand-500 bg-brand-50 transition-colors">
            ✏️ 入力・編集
        </button>
        <button onclick="switchTab('preview')" id="tab-preview" class="flex-1 py-3 text-sm font-bold text-gray-400 border-b-4 border-transparent hover:bg-gray-50 transition-colors">
            📱 プレビュー確認
        </button>
    </div>

    <!-- MAIN CONTENT WRAPPER -->
    <div class="flex-1 flex flex-col md:flex-row overflow-hidden relative">

        <!-- ========================================== -->
        <!-- LEFT PANEL: STAFF CONTROLS (INPUT)        -->
        <!-- ========================================== -->
        <aside id="panel-edit" class="w-full md:w-1/2 lg:w-5/12 bg-white border-r border-brand-200 h-full flex flex-col shadow-lg z-10 absolute md:relative inset-0 md:inset-auto overflow-hidden">
            <div class="p-4 bg-brand-600 text-white flex justify-between items-center shadow-md shrink-0">
                <div>
                    <h1 class="font-bold text-lg">🌿 si'seレポート作成</h1>
                    <p class="text-xs text-brand-100 md:block hidden">設定後に右側で保存</p>
                    <p class="text-xs text-brand-100 md:hidden block">入力後に「プレビュー」へ</p>
                </div>
                <button onclick="resetForm()" class="text-xs bg-brand-800 px-3 py-1 rounded hover:bg-brand-900 transition border border-brand-500">リセット</button>
            </div>

            <div class="flex-1 overflow-y-auto p-6 custom-scroll space-y-8 pb-20 md:pb-6">
                
                <!-- 1. Customer Info -->
                <section>
                    <h3 class="text-sm font-bold text-brand-600 uppercase tracking-wide mb-3 border-b border-brand-100 pb-1">① 基本情報</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold mb-1 text-gray-500">お客様名</label>
                            <input type="text" id="customerName" class="w-full border border-gray-300 rounded p-2 text-sm focus:ring-2 focus:ring-brand-500 outline-none" placeholder="例: 山田 花子" oninput="updateUI()">
                        </div>
                        <div>
                            <label class="block text-xs font-bold mb-1 text-gray-500">来店日</label>
                            <input type="date" id="visitDate" class="w-full border border-gray-300 rounded p-2 text-sm focus:ring-2 focus:ring-brand-500 outline-none" oninput="updateUI()">
                        </div>
                    </div>
                </section>

                <!-- 2. Today's Menu -->
                <section>
                    <h3 class="text-sm font-bold text-brand-600 uppercase tracking-wide mb-3 border-b border-brand-100 pb-1">② 本日の施術 (選択)</h3>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <label class="flex items-center space-x-2 cursor-pointer bg-brand-50 p-2 rounded border border-transparent hover:border-brand-200 transition"><input type="checkbox" class="menu-check form-checkbox text-brand-600 accent-brand-600" value="骨盤矯正" checked onchange="updateUI()"> <span>骨盤矯正</span></label>
                        <label class="flex items-center space-x-2 cursor-pointer bg-brand-50 p-2 rounded border border-transparent hover:border-brand-200 transition"><input type="checkbox" class="menu-check form-checkbox text-brand-600 accent-brand-600" value="姿勢矯正" checked onchange="updateUI()"> <span>姿勢矯正</span></label>
                        <label class="flex items-center space-x-2 cursor-pointer bg-brand-50 p-2 rounded border border-transparent hover:border-brand-200 transition"><input type="checkbox" class="menu-check form-checkbox text-brand-600 accent-brand-600" value="小顔矯正" onchange="updateUI()"> <span>小顔矯正</span></label>
                        <label class="flex items-center space-x-2 cursor-pointer bg-brand-50 p-2 rounded border border-transparent hover:border-brand-200 transition"><input type="checkbox" class="menu-check form-checkbox text-brand-600 accent-brand-600" value="ほぐし" onchange="updateUI()"> <span>ほぐし</span></label>
                    </div>
                </section>

                <!-- 3. Current State (Chart Data) - UPDATED METRICS -->
                <section>
                    <h3 class="text-sm font-bold text-brand-600 uppercase tracking-wide mb-3 border-b border-brand-100 pb-1">③ 現在の状態・課題 (1-5点)</h3>
                    <p class="text-xs text-gray-500 mb-2">※数値を変更するとレーダーチャートに反映されます</p>
                    <div class="space-y-4 bg-white p-2">
                        
                        <!-- 1. 姿勢 -->
                        <div class="flex flex-col gap-1">
                            <div class="flex justify-between items-center">
                                <label class="text-sm font-bold text-gray-700">★姿勢</label>
                                <span id="valPosture" class="text-sm font-bold w-4 text-center text-brand-600">3</span>
                            </div>
                            <p class="text-[10px] text-gray-400">巻き肩、猫背、反り腰、立ち方、座り方</p>
                            <input type="range" id="scorePosture" min="1" max="5" step="1" value="3" class="w-full accent-brand-500" oninput="updateChartData()">
                        </div>

                        <!-- 2. 骨盤 -->
                        <div class="flex flex-col gap-1">
                            <div class="flex justify-between items-center">
                                <label class="text-sm font-bold text-gray-700">★骨盤</label>
                                <span id="valPelvis" class="text-sm font-bold w-4 text-center text-brand-600">3</span>
                            </div>
                            <p class="text-[10px] text-gray-400">足の左右差、産後骨盤、ヒップアップ、O脚Ｘ脚</p>
                            <input type="range" id="scorePelvis" min="1" max="5" step="1" value="3" class="w-full accent-brand-500" oninput="updateChartData()">
                        </div>

                        <!-- 3. 顔・頭 -->
                        <div class="flex flex-col gap-1">
                            <div class="flex justify-between items-center">
                                <label class="text-sm font-bold text-gray-700">★顔・頭</label>
                                <span id="valFace" class="text-sm font-bold w-4 text-center text-brand-600">3</span>
                            </div>
                            <p class="text-[10px] text-gray-400">フェイスライン、頬骨、ハチ、眼精疲労、左右差</p>
                            <input type="range" id="scoreFace" min="1" max="5" step="1" value="3" class="w-full accent-brand-500" oninput="updateChartData()">
                        </div>

                        <!-- 4. 代謝・巡り -->
                        <div class="flex flex-col gap-1">
                            <div class="flex justify-between items-center">
                                <label class="text-sm font-bold text-gray-700">★代謝・巡り</label>
                                <span id="valFlow" class="text-sm font-bold w-4 text-center text-brand-600">3</span>
                            </div>
                            <p class="text-[10px] text-gray-400">代謝、むくみ、冷え</p>
                            <input type="range" id="scoreFlow" min="1" max="5" step="1" value="3" class="w-full accent-brand-500" oninput="updateChartData()">
                        </div>

                        <!-- 5. 柔軟性・バランス -->
                        <div class="flex flex-col gap-1">
                            <div class="flex justify-between items-center">
                                <label class="text-sm font-bold text-gray-700">★柔軟性・バランス</label>
                                <span id="valFlex" class="text-sm font-bold w-4 text-center text-brand-600">3</span>
                            </div>
                            <p class="text-[10px] text-gray-400">筋肉、関節、左右差、歩き方、体幹</p>
                            <input type="range" id="scoreFlex" min="1" max="5" step="1" value="3" class="w-full accent-brand-500" oninput="updateChartData()">
                        </div>

                    </div>
                </section>

                <!-- 4. Message & Goal -->
                <section>
                    <h3 class="text-sm font-bold text-brand-600 uppercase tracking-wide mb-3 border-b border-brand-100 pb-1">④ コメント / 次の目標</h3>
                    <div class="mb-3">
                        <label class="block text-xs font-bold mb-1 text-gray-500">テンプレート選択</label>
                        <select id="msgTemplate" class="w-full border border-gray-300 rounded p-2 text-sm bg-white text-gray-600" onchange="applyTemplate()">
                            <option value="">カスタム入力...</option>
                            <!-- Original Templates -->
                            <option value="improvement">【継続】姿勢改善・称賛パターン</option>
                            <option value="cold">【季節】冷え・むくみケアパターン</option>
                            <option value="face">【顔】小顔・食いしばりケアパターン</option>
                            <option value="first">【初回/初期】立ち方・意識付けパターン</option>
                            <!-- Added Templates with Clear Titles -->
                            <option value="calf">【足】ふくらはぎの疲労・張り</option>
                            <option value="scapula">【肩・背中】肩甲骨周りの硬さ</option>
                            <option value="face_swelling">【顔】むくみケア</option>
                            <option value="face_square">【顔】エラ張り・食いしばり</option>
                            <option value="double_chin">【顔】二重顎・首元のケア</option>
                            <option value="eye_level">【顔】目の高さ・左右差</option>
                            <option value="face_width">【顔】横幅・小顔ケア</option>
                            <option value="pelvis_distortion">【骨盤】歪み・バランス</option>
                            <option value="hip_distortion">【下半身】股関節の柔軟性</option>
                            <option value="lower_body">【下半身】代謝・むくみ</option>
                            <option value="leg_swelling">【足】むくみ・冷え対策</option>
                            <option value="balance">【全身】バランス・体幹</option>
                            <option value="rolled_shoulder">【姿勢】巻き肩ケア</option>
                            <option value="straight_neck">【首】ストレートネック</option>
                            <option value="hunchback">【姿勢】猫背改善</option>
                            <option value="scapula_wing">【背中】肩甲骨出し・美背中</option>
                            <option value="cold_hands">【末端】手先の冷え</option>
                        </select>
                    </div>
                    <textarea id="coachComment" class="w-full border border-gray-300 rounded p-2 text-sm h-24 focus:ring-2 focus:ring-brand-500 outline-none resize-none" placeholder="ここにお客様へのフィードバックを入力..." oninput="updateUI()"></textarea>
                </section>

                <!-- 5. Recommended Stretches -->
                <section>
                    <h3 class="text-sm font-bold text-brand-600 uppercase tracking-wide mb-3 border-b border-brand-100 pb-1">⑤ 宿題ストレッチ</h3>
                    <div id="stretchSelectionArea" class="space-y-4">
                        <!-- Populated by JS -->
                    </div>
                </section>

                <!-- Spacer for mobile scroll -->
                <div class="h-10 md:hidden"></div>

            </div>
        </aside>

        <!-- ========================================== -->
        <!-- RIGHT PANEL: PREVIEW (OUTPUT TARGET)      -->
        <!-- ========================================== -->
        <main id="panel-preview" class="w-full md:w-1/2 lg:w-7/12 bg-gray-100 h-full overflow-y-auto custom-scroll relative hidden md:block">
            
            <div class="flex flex-col items-center justify-start min-h-full p-4 md:p-8 pb-20">
                
                <!-- DOWNLOAD BUTTON (Sticky position to stay visible) -->
                <div class="sticky top-0 z-50 w-full max-w-[400px] flex justify-end mb-2 pointer-events-none">
                    <div class="pointer-events-auto">
                        <button onclick="downloadImage()" class="flex items-center gap-2 bg-brand-600 text-white px-4 py-2 rounded-full shadow-lg hover:bg-brand-500 hover:shadow-xl transition transform hover:-translate-y-0.5 font-bold text-sm border-2 border-white">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            画像を保存
                        </button>
                        <p id="saveMsg" class="text-xs text-brand-600 text-center mt-1 opacity-0 transition bg-white/80 rounded px-1">保存しました！</p>
                    </div>
                </div>

                <!-- PHONE CONTAINER (The part to screenshot) -->
                <div id="captureArea" class="bg-white w-full max-w-[400px] shadow-2xl overflow-hidden relative text-gray-800 h-auto" style="min-height: 700px; border-radius: 20px;">
                    
                    <!-- Top Decoration -->
                    <div class="bg-gradient-to-r from-brand-300 to-brand-500 h-3 w-full"></div>

                    <!-- Header -->
                    <div class="p-6 pb-4 text-center bg-brand-50/50">
                        <p class="text-[10px] text-brand-500 font-bold tracking-[0.2em] uppercase mb-1">si'se Personal After Care Sheet</p>
                        <h2 class="text-2xl font-bold text-gray-700 mb-1" id="previewName">様</h2>
                        <p class="text-xs text-brand-300 font-medium" id="previewDate">2023.00.00</p>
                    </div>

                    <!-- 1. Today's Care (EMPHASIZED) -->
                    <div class="px-6 mb-6">
                        <div class="relative py-4">
                            <div class="absolute inset-0 flex items-center" aria-hidden="true">
                                <div class="w-full border-t border-brand-100"></div>
                            </div>
                            <div class="relative flex justify-center">
                                <span class="px-2 bg-white text-xs font-bold text-brand-400 uppercase tracking-widest">Today's Menu</span>
                            </div>
                        </div>
                        
                        <!-- Emphasized Menu Container -->
                        <div id="previewMenu" class="flex flex-wrap justify-center gap-3">
                            <!-- Badges injected here with stronger styling -->
                        </div>
                    </div>

                    <!-- 2. Body Analysis (Chart) -->
                    <div class="px-6 mb-6">
                        <h4 class="text-xs font-bold text-brand-400 mb-2 text-center tracking-widest uppercase">Body Balance</h4>
                        <div class="bg-brand-50/50 rounded-2xl p-4 chart-wrapper border border-brand-50 shadow-[inset_0_2px_4px_rgba(0,0,0,0.02)]">
                            <!-- Chart Container for Chart.js -->
                            <div class="chart-container" style="position: relative; width: 100%; height: 100%;">
                                <canvas id="bodyChart"></canvas>
                            </div>
                        </div>
                        <div class="mt-3 flex justify-between text-[10px] text-brand-400 px-4">
                            <span>Previous</span>
                            <span>Current</span>
                            <span>Goal</span>
                        </div>
                    </div>

                    <!-- 3. Coach Feedback -->
                    <div class="px-6 mb-8">
                        <h4 class="text-xs font-bold text-brand-400 mb-3 text-center tracking-widest uppercase">Feedback & Goal</h4>
                        <div class="bg-white relative">
                            <!-- Quotation mark decoration -->
                            <span class="absolute -top-2 -left-1 text-4xl text-brand-200 opacity-50 font-serif leading-none">“</span>
                            <p id="previewComment" class="text-sm leading-relaxed text-gray-600 whitespace-pre-wrap pl-6 border-l-2 border-brand-300 py-1">
                                本日は施術お疲れ様でした。
                                骨盤周りの動きは良くなっています！次回は肩甲骨周りをさらに広げていきましょう。
                            </p>
                        </div>
                    </div>

                    <!-- 4. Home Work (Stretches) -->
                    <div class="bg-gradient-to-br from-brand-600 to-brand-800 text-white p-6 pb-10 min-h-[220px]">
                        <div class="flex items-center justify-center gap-2 mb-6">
                            <span class="text-lg bg-white/20 w-8 h-8 flex items-center justify-center rounded-full text-white">🧘‍♀️</span>
                            <h4 class="font-bold tracking-[0.2em] text-sm text-brand-100">HOME CARE</h4>
                        </div>
                        
                        <div id="previewStretches" class="space-y-4">
                            <!-- Stretch Cards injected here -->
                        </div>

                        <div class="mt-8 text-center border-t border-white/10 pt-4">
                             <p class="text-[10px] text-brand-200 opacity-90">
                                美しさは日々の積み重ねから✨<br>
                                ご不明点はLINEにていつでもご相談ください。
                            </p>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <!-- JavaScript Implementation -->
    <script>
        // ==========================================
        // 1. DATA SOURCE
        // ==========================================
        
        const commentTemplates = {
            improvement: "姿勢改善に向けて現在頑張っていますが、状態はいかがでしょうか？\n本日は〇〇の位置が良くなっています。少し意識するだけでもより近づいていけますので、引き続き頑張っていきましょう！",
            cold: "最近寒いですね。足のむくみや冷えを感じて肩に力が入ってしまいがちです。\n本日は骨盤矯正で土台を整えて循環をよくし、姿勢矯正で可動域を広げて巻き肩をケアしました。お風呂上がりなどにストレッチを行ってみてください。",
            face: "本日は姿勢矯正で肩甲骨、肩まわりを動かして呼吸をしやすくし、小顔矯正で食いしばりや側頭筋などを弛めてお身体をスッキリさせました！\n顔周りの緊張が取れると睡眠の質も上がります。",
            first: "立ち方（座り方、歩き方）はご自宅や職場でも意識できていますか？\nまずはご自身で「気づいた時に直す」範囲で大丈夫です。骨盤の使い方、肩首の位置など、次回またチェックさせていただきますね。",
            // Added Templates
            calf: "本日は足の疲労がすごく、かたかったです！\n血行をよくするために足のトレーニングをお伝えします。",
            scapula: "肩甲骨周りの硬さがありました。肩甲骨の可動域を広げると血行も良くなり、肩こり、背中のこりもスッキリしてきます。こちらを行ってみてください。",
            face_swelling: "本日もご来店頂きありがとうございます。顔のむくみには水分をしっかりと取って頂き、塩分の摂りすぎなどに注意してみてください。",
            face_square: "本日もご来店頂きありがとうございます。エラ張りは噛み締めからくることがほとんどですので、普段からエラが張っているかを確認してみてください。",
            double_chin: "本日もご来店頂きありがとうございます。デスクワークで下を向くことが多いと思いますので、休憩中でも構いませんので、ストレッチしてみてください。",
            eye_level: "本日もご来店頂きありがとうございます。目の高さの違いが出ていましたので、毎日こちらを続けてみてください。",
            face_width: "本日もご来店頂きありがとうございます。顔の横幅を変えるには毎日のケアが必要となりますので、こちらを参考にやってみてください。",
            pelvis_distortion: "骨盤は骨格の土台ですので、歪むと腰痛や肩こり、内臓圧迫による不調の原因となり、バランスが崩れて体に負担がかかります。",
            hip_distortion: "日常動作で股関節を使えていない方が多く、腰から動いてしまっていることが腰痛や足の張りの原因になりやすいため、「股関節」から動かして体の負担を減らすことが大切です。",
            lower_body: "お尻や太もも等の大きな筋肉が硬いと、代謝が落ちやすく血行不良やむくみに繋がりやすくなります。関節が歪むことでの影響も強いため、各関節を正しい位置に戻すことが大切です。",
            leg_swelling: "運動不足による筋肉量の低下や、冷え・水分不足による循環機能の低下で老廃物が溜まりやすくなっていますので、しっかりとしたケアが必要です。",
            balance: "体のバランスが保てないのは、骨盤や背骨の歪みも影響していますが、足首、股関節、体幹の意識も必要ですので、全体を整えていくことが大切です。",
            rolled_shoulder: "お風呂上がりにやってみてください。",
            straight_neck: "定期的にやってみてください。",
            hunchback: "「背中が丸いな」と感じたらやってみてください。",
            scapula_wing: "まずは1日5回から始めて徐々に回数を増やしてください。",
            cold_hands: "なるべく湯船に浸かってください。"
        };

        const stretchData = {
            posture: [
                {
                    id: "p1",
                    title: "胸筋・二頭筋ストレッチ",
                    icon: "👐",
                    text: "①壁の横に立つ ②壁側の手を斜め後ろ上につく ③体を反対側に向けて胸や腕を伸ばす (15秒)"
                },
                {
                    id: "p2",
                    title: "前鋸筋ストレッチ(壁)",
                    icon: "🧱",
                    text: "①手を真上に伸ばす ②体を壁に密着させ、手のひらを前に向ける ③腕を真上に上げて脇の下を伸ばす"
                },
                {
                    id: "p3",
                    title: "上腕三頭筋ストレッチ",
                    icon: "💪",
                    text: "①肘を後に曲げる ②腕の位置は耳よりやや後ろへ ③二の腕や脇を伸ばす"
                },
                {
                    id: "p4",
                    title: "肩回しエクササイズ",
                    icon: "🔄",
                    text: "①手を肩に置く ②大きく後ろから前へ回す ③反対回しも行う (ゴリゴリ鳴る場合はゆっくり動かす)"
                },
                {
                    id: "p5",
                    title: "巻き肩ケア",
                    icon: "🥐",
                    text: "①肘を曲げ、上腕を脇につける ②前腕部分だけ後ろ回しをする (後ろの肩周りに効いていればOK)"
                },
                // Added Posture Items
                {
                    id: "p_scapula",
                    title: "肩甲骨ケア",
                    icon: "🦋",
                    text: "①胸を開き肩甲骨を寄せる<br>②ゆっくり5秒キープして力を抜く<br>③5回"
                },
                {
                    id: "p_balance",
                    title: "バランス・体幹",
                    icon: "🏄",
                    text: "・プランク→うつ伏せになり肘と足のつま先で支える頭からかかとまで一直線、腰を反らないように<br>・タオルギャザー→床にタオルを置き両足の指を使って手繰り寄せる<br>・デッドバグ→仰向けになり両手足を天井に上げ左右対称に上げ下げする"
                },
                {
                    id: "p_roll",
                    title: "巻き肩(壁)",
                    icon: "🐌",
                    text: "壁を使ってストレッチ"
                },
                {
                    id: "p_neck",
                    title: "ストレートネック",
                    icon: "📱",
                    text: "真上を向く"
                },
                {
                    id: "p_hunch",
                    title: "猫背リセット",
                    icon: "🐈",
                    text: "腕を後ろにして背中を縮めてからリラックス"
                },
                {
                    id: "p_wing",
                    title: "肩甲骨出し",
                    icon: "👼",
                    text: "バンザイをしてから背中で肘をつけるイメージでギュッと３秒力を入れてバンザイ"
                },
                {
                    id: "p_cold",
                    title: "手先の冷え",
                    icon: "🧤",
                    text: "湯船に浸かっている状態で手をグーパーしてください。"
                }
            ],
            pelvis: [
                {
                    id: "l1",
                    title: "お尻ストレッチ(椅子)",
                    icon: "🪑",
                    text: "①椅子に座り片足を上げる ②足首を反対の膝上に置く ③背筋を伸ばし上半身を前へ倒す"
                },
                {
                    id: "l2",
                    title: "お尻ストレッチ(床)",
                    icon: "🧘",
                    text: "①椅子と同じ足の形を作る ②立てている膝を自分の方へ抱き寄せてお尻を伸ばす"
                },
                {
                    id: "l3",
                    title: "裏モモ伸ばし",
                    icon: "🦶",
                    text: "①片足を台に乗せる ②膝を伸ばし足首を最大に曲げる ③膝が曲がらないよう体を前に倒す"
                },
                {
                    id: "l4",
                    title: "内腿ほぐし",
                    icon: "🦵",
                    text: "①あぐらの状態で内腿を触る ②手のひらで内腿を覆い、体重をかけて押圧する"
                },
                // Added Pelvis Items
                {
                    id: "l_calf",
                    title: "ふくらはぎ",
                    icon: "🦵",
                    text: "①壁や椅子につかまり、かかとをゆっくり上げ下げする<br>②反動を使わず、ゆっくり行う<br>③10回×2セット"
                },
                {
                    id: "l_pelvis",
                    title: "骨盤の歪み",
                    icon: "⚖️",
                    text: "・骨盤ゆらし→①仰向けで寝る。②腰幅に足を開く。③呼吸しながら足先をワイパーのように動かす。<br>・骨盤体操→①椅子に浅く座る。②腰幅に足を開く。③腰に手をやり、胸や背中一直線にし背中を曲げる、戻す事で骨盤をしっかり動かす。<br>・ブリッジ→①仰向けで膝を立てる。②背中〜お尻一直線意識し持ち上げる。"
                },
                {
                    id: "l_hip",
                    title: "股関節の歪み",
                    icon: "🦴",
                    text: "・①仰向けね寝る。②片膝を抱え肩の方向に引き寄せる。③反対も行う。10〜15秒。<br>・①両膝を立て左右に倒す、まわす等。10回<br>・①階段1段くらいの高さで良いので片足を伸ばした状態でかかとをつける...（かかとから足裏にかけて伸びを感じたらok）"
                },
                {
                    id: "l_lower",
                    title: "下半身ケア",
                    icon: "👖",
                    text: "・スクワット、有酸素運動→ ①足を肩幅に広げる。②背筋を伸ばし、お尻を後ろに引くようにしゃがむ。③かかとで床を押しながらゆっくり上がる。<br>・もも前(クワドストレッチ)→①片足で立ちあげた足の足首か爪先を持ちお尻に向けて曲げて10秒キープ"
                },
                {
                    id: "l_swelling",
                    title: "足のむくみ・冷え",
                    icon: "👣",
                    text: "・つま先立ち運動→体一直線にしかかとを上げ下げやキープする<br>・足の指に手の指を入れまわす、伸ばす、曲げる<br>・膝窩をテニスボール等で流す"
                }
            ],
            face: [
                {
                    id: "f1",
                    title: "鎖骨・首ストレッチ",
                    icon: "🦢",
                    text: "①両手で鎖骨を下に引く ②首を後ろへ倒す ③口を「ウ」の形にして15秒キープ"
                },
                {
                    id: "f2",
                    title: "咬筋（食いしばり）ケア",
                    icon: "😬",
                    text: "①噛み締めると硬くなる部分(咬筋)を指で押さえる ②ゆっくり小刻みに揺らして緩める"
                },
                {
                    id: "f3",
                    title: "耳回し",
                    icon: "👂",
                    text: "①耳を持つ ②横にゆっくり引っ張ったり、回したりする (顔の血流UP)"
                },
                {
                    id: "f4",
                    title: "後頭下筋リリース",
                    icon: "🛌",
                    text: "①仰向けで寝る ②後頭部のくぼみ(後頭下筋)に手を置く ③顎を少し上げゆっくり深呼吸"
                },
                // Added Face Items
                {
                    id: "f_swelling",
                    title: "顔のむくみ",
                    icon: "💧",
                    text: "オイルやクリームを首筋に塗って頂き、首筋からフェイスラインに流すようにマッサージしてみてください。"
                },
                {
                    id: "f_square",
                    title: "エラ張りケア",
                    icon: "📐",
                    text: "手をぐーにして頬骨の下に当て口を軽く開けながら奥の筋肉をほぐすように左右に動かしながらほぐしていきましょう。"
                },
                {
                    id: "f_double",
                    title: "二重顎ケア",
                    icon: "🆙",
                    text: "①顎先をなるべく天井に向けて上を向く ②喉から首が伸びているのを感じるくらい伸ばし20秒くらい続ける"
                },
                {
                    id: "f_eye",
                    title: "目の左右差",
                    icon: "👁️",
                    text: "①耳の上に4本指を当て前回し30秒、後ろ回し30秒<br>②耳をチョキの指で根元から挟み大きく後ろ回し30秒、前回し30秒<br>③下がっている方の頬骨の下に手根を当てて斜め上に押し上げ(30秒)"
                },
                {
                    id: "f_width",
                    title: "顔の横幅ケア",
                    icon: "↔️",
                    text: "①手をグーにして、頬骨の下に関節を当てて20秒押す<br>②頬骨に沿って内側に移動し、20秒押す<br>③手根を頬骨に当てて、両サイドからじんわり押す<br>④更に内側にずらし押す"
                }
            ]
        };

        // ==========================================
        // 2. INITIALIZATION
        // ==========================================
        
        let myChart = null;

        window.onload = function() {
            // Set Date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('visitDate').value = today;
            
            // Render Stretches in Panel
            renderStretchSelection();

            // Initialize Chart
            initChart();

            // Initial UI Update
            updateUI();
        };

        // ==========================================
        // 3. LOGIC & FUNCTIONS
        // ==========================================

        // --- Tab Switching Logic (Mobile) ---
        function switchTab(tabName) {
            const editPanel = document.getElementById('panel-edit');
            const previewPanel = document.getElementById('panel-preview');
            const editTabBtn = document.getElementById('tab-edit');
            const previewTabBtn = document.getElementById('tab-preview');

            if (tabName === 'edit') {
                // Show Edit, Hide Preview
                editPanel.classList.remove('hidden');
                previewPanel.classList.add('hidden');
                
                // Style Tabs
                editTabBtn.classList.replace('text-gray-400', 'text-brand-600');
                editTabBtn.classList.replace('border-transparent', 'border-brand-500');
                editTabBtn.classList.add('bg-brand-50');
                
                previewTabBtn.classList.replace('text-brand-600', 'text-gray-400');
                previewTabBtn.classList.replace('border-brand-500', 'border-transparent');
                previewTabBtn.classList.remove('bg-brand-50');

            } else {
                // Hide Edit, Show Preview
                editPanel.classList.add('hidden');
                previewPanel.classList.remove('hidden');
                
                // Style Tabs
                previewTabBtn.classList.replace('text-gray-400', 'text-brand-600');
                previewTabBtn.classList.replace('border-transparent', 'border-brand-500');
                previewTabBtn.classList.add('bg-brand-50');
                
                editTabBtn.classList.replace('text-brand-600', 'text-gray-400');
                editTabBtn.classList.replace('border-brand-500', 'border-transparent');
                editTabBtn.classList.remove('bg-brand-50');
                
                // Refresh chart since canvas might have resized while hidden
                if (myChart) myChart.resize();
            }
        }

        // Ensure Reset for Desktop on Resize
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 768) { // md breakpoint
                document.getElementById('panel-edit').classList.remove('hidden');
                document.getElementById('panel-preview').classList.remove('hidden');
            } else {
                switchTab('edit');
            }
        });


        function renderStretchSelection() {
            const container = document.getElementById('stretchSelectionArea');
            let html = '';

            const createCategory = (key, label, colorClass) => {
                let items = stretchData[key].map(s => `
                    <label class="flex items-start space-x-2 p-2 rounded hover:bg-brand-50 cursor-pointer text-xs border border-transparent hover:border-brand-100 transition">
                        <input type="checkbox" class="stretch-check mt-1 form-checkbox text-brand-600 rounded focus:ring-brand-500 accent-brand-500" value="${key}-${s.id}" onchange="updateUI()">
                        <div>
                            <span class="font-bold text-gray-700 block flex items-center gap-1">${s.icon} ${s.title}</span>
                            <span class="text-[10px] text-gray-400 truncate block mt-0.5">${s.text.replace(/<br>/g, ' ').substring(0, 30)}...</span>
                        </div>
                    </label>
                `).join('');

                return `
                    <details class="group bg-white border border-brand-100 rounded-lg open:shadow-sm" open>
                        <summary class="p-3 cursor-pointer font-bold text-xs text-brand-600 bg-brand-50 rounded-t-lg group-open:border-b border-brand-100 flex justify-between items-center transition hover:bg-brand-100">
                            ${label}
                            <span class="text-brand-400 text-[10px] transition-transform group-open:rotate-180">▼</span>
                        </summary>
                        <div class="p-2 grid grid-cols-1 gap-1">
                            ${items}
                        </div>
                    </details>
                `;
            };

            html += createCategory('posture', '姿勢・上半身', '');
            html += createCategory('pelvis', '骨盤・下半身', '');
            html += createCategory('face', '顔・首・呼吸', '');

            container.innerHTML = html;
        }

        function applyTemplate() {
            const key = document.getElementById('msgTemplate').value;
            const textarea = document.getElementById('coachComment');
            if (key && commentTemplates[key]) {
                textarea.value = commentTemplates[key];
                updateUI();
            }
        }

        function initChart() {
            const ctx = document.getElementById('bodyChart').getContext('2d');
            
            myChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    // UPDATED LABELS HERE
                    labels: ['姿勢', '骨盤', '顔・頭', '代謝・巡り', '柔軟・バランス'],
                    datasets: [{
                        label: 'Condition',
                        data: [3, 3, 3, 3, 3],
                        backgroundColor: 'rgba(108, 168, 138, 0.4)', 
                        borderColor: '#6ca88a', 
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#52856d', 
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#345244',
                        borderWidth: 2,
                        pointRadius: 3
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    scales: {
                        r: {
                            angleLines: { color: '#e1efe7' }, 
                            grid: { color: '#f2f8f5' }, 
                            pointLabels: {
                                font: {
                                    size: 10,
                                    family: "'Zen Kaku Gothic New', sans-serif",
                                    weight: 'bold'
                                },
                                color: '#52856d'
                            },
                            suggestedMin: 0,
                            suggestedMax: 5,
                            ticks: {
                                display: false,
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    }
                }
            });
        }

        function updateChartData() {
            // UPDATED ID MAPPING
            const s1 = document.getElementById('scorePosture'); // 姿勢
            const s2 = document.getElementById('scorePelvis');  // 骨盤
            const s3 = document.getElementById('scoreFace');    // 顔・頭
            const s4 = document.getElementById('scoreFlow');    // 代謝・巡り
            const s5 = document.getElementById('scoreFlex');    // 柔軟性・バランス

            // Update Number Displays
            document.getElementById('valPosture').innerText = s1.value;
            document.getElementById('valPelvis').innerText = s2.value;
            document.getElementById('valFace').innerText = s3.value;
            document.getElementById('valFlow').innerText = s4.value;
            document.getElementById('valFlex').innerText = s5.value;

            // Update Chart Data Array (Order must match 'labels' in initChart)
            // Order: ['姿勢', '骨盤', '顔・頭', '代謝・巡り', '柔軟・バランス']
            if (myChart) {
                myChart.data.datasets[0].data = [s1.value, s2.value, s3.value, s4.value, s5.value];
                myChart.update();
            }
        }

        function updateUI() {
            // 1. Name & Date
            const name = document.getElementById('customerName').value || 'お客様';
            const dateVal = document.getElementById('visitDate').value;
            
            document.getElementById('previewName').innerText = name + (name.includes('様') ? '' : ' 様');
            document.getElementById('previewDate').innerText = dateVal.replace(/-/g, '.');

            // 2. Menu Badges (Emphasized)
            const menuContainer = document.getElementById('previewMenu');
            menuContainer.innerHTML = '';
            const menuChecks = document.querySelectorAll('.menu-check:checked');
            if (menuChecks.length === 0) {
                menuContainer.innerHTML = '<span class="text-xs text-brand-300">施術内容なし</span>';
            } else {
                menuChecks.forEach(cb => {
                    const span = document.createElement('div');
                    span.className = 'px-4 py-2 bg-brand-100 text-brand-800 text-sm rounded-lg border-2 border-brand-200 font-bold shadow-sm flex items-center gap-2';
                    span.innerHTML = `<span class="text-brand-500">✔</span> ${cb.value}`;
                    menuContainer.appendChild(span);
                });
            }

            // 3. Comment
            const comment = document.getElementById('coachComment').value;
            document.getElementById('previewComment').innerText = comment || "本日はご来店ありがとうございました。\nお伝えしたストレッチを無理のない範囲で行ってみてください。";

            // 4. Stretches
            const stretchContainer = document.getElementById('previewStretches');
            stretchContainer.innerHTML = '';
            const stretchChecks = document.querySelectorAll('.stretch-check:checked');
            
            if (stretchChecks.length === 0) {
                stretchContainer.innerHTML = '<p class="text-xs text-brand-100 text-center opacity-70">本日の特別な宿題はありません<br>水分をしっかり摂って休みましょう</p>';
            } else {
                stretchChecks.forEach(cb => {
                    const [cat, id] = cb.value.split('-');
                    const data = stretchData[cat].find(s => s.id === id);
                    if (data) {
                        const div = document.createElement('div');
                        div.className = 'bg-white/10 backdrop-blur-md p-4 rounded-xl border border-white/30 shadow-sm';
                        div.innerHTML = `
                            <div class="flex items-center gap-3 mb-2 border-b border-white/20 pb-2">
                                <span class="text-xl bg-white text-brand-600 w-8 h-8 flex items-center justify-center rounded-full shadow-sm">${data.icon}</span>
                                <h5 class="font-bold text-sm text-white tracking-wide">${data.title}</h5>
                            </div>
                            <p class="text-xs text-brand-50 leading-relaxed opacity-95">
                                ${data.text}
                            </p>
                        `;
                        stretchContainer.appendChild(div);
                    }
                });
            }
        }

        function resetForm() {
            if(confirm('入力をリセットしますか？')) {
                document.getElementById('customerName').value = '';
                document.getElementById('coachComment').value = '';
                document.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked = false);
                document.querySelectorAll('input[type="range"]').forEach(r => r.value = 3);
                updateChartData();
                updateUI();
            }
        }

        // ==========================================
        // DOWNLOAD IMAGE FUNCTION
        // ==========================================
        function downloadImage() {
            const element = document.getElementById('captureArea');
            const msg = document.getElementById('saveMsg');
            
            msg.style.opacity = '1';
            msg.innerText = '生成中...';

            html2canvas(element, {
                scale: 2, 
                backgroundColor: '#ffffff',
                useCORS: true 
            }).then(canvas => {
                const link = document.createElement('a');
                const name = document.getElementById('customerName').value || 'Customer';
                const date = document.getElementById('visitDate').value || 'Date';
                
                link.download = `AfterCare_${name}_${date}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();

                msg.innerText = '保存しました！';
                setTimeout(() => {
                    msg.style.opacity = '0';
                }, 2000);
            }).catch(err => {
                console.error(err);
                msg.innerText = 'エラーが発生しました';
            });
        }

    </script>
</body>
</html>
