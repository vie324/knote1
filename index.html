<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beauty Seitai: After-Care Report Generator</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- html2canvas (Screenshot Library) -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Configuration & Styles -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Zen Kaku Gothic New"', 'sans-serif'],
                    },
                    colors: {
                        // Gentle Green Palette (Sage/Nature inspired)
                        brand: {
                            50: '#f2f8f5',   // Very light wash
                            100: '#e1efe7',  // Pale mint
                            200: '#c5e0d1',  // Soft green
                            300: '#9cc7b1',  // Muted green
                            500: '#6ca88a',  // Main "Gentle Green"
                            600: '#52856d',  // Darker Text
                            800: '#345244',  // Deep Forest
                            accent: '#94a3b8',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f0fdf4; /* Very pale green background */
        }
        /* Custom scrollbar for the panel */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #c5e0d1; /* brand-200 */
            border-radius: 3px;
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #9cc7b1; /* brand-300 */
        }
        
        /* Chart Container Strategy */
        .chart-wrapper {
            position: relative;
            width: 100%;
            height: 250px; /* Fixed height for consistency */
            display: flex;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body class="text-gray-700 h-screen overflow-hidden flex flex-col font-sans">

    <!-- Chosen Palette: Gentle Green (Sage/Nature) for healing and calm. -->

    <!-- ========================================== -->
    <!-- MOBILE TABS (Visible only on small screens) -->
    <!-- ========================================== -->
    <div class="md:hidden flex bg-white border-b border-brand-200 z-50 shrink-0 shadow-sm">
        <button onclick="switchTab('edit')" id="tab-edit" class="flex-1 py-3 text-sm font-bold text-brand-600 border-b-4 border-brand-500 bg-brand-50 transition-colors">
            âœï¸ å…¥åŠ›ãƒ»ç·¨é›†
        </button>
        <button onclick="switchTab('preview')" id="tab-preview" class="flex-1 py-3 text-sm font-bold text-gray-400 border-b-4 border-transparent hover:bg-gray-50 transition-colors">
            ğŸ“± ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç¢ºèª
        </button>
    </div>

    <!-- MAIN CONTENT WRAPPER -->
    <div class="flex-1 flex flex-col md:flex-row overflow-hidden relative">

        <!-- ========================================== -->
        <!-- LEFT PANEL: STAFF CONTROLS (INPUT)        -->
        <!-- ========================================== -->
        <!-- Added ID for toggling -->
        <aside id="panel-edit" class="w-full md:w-1/2 lg:w-5/12 bg-white border-r border-brand-200 h-full flex flex-col shadow-lg z-10 absolute md:relative inset-0 md:inset-auto overflow-hidden">
            <div class="p-4 bg-brand-600 text-white flex justify-between items-center shadow-md shrink-0">
                <div>
                    <h1 class="font-bold text-lg">ğŸŒ¿ ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ</h1>
                    <p class="text-xs text-brand-100 md:block hidden">è¨­å®šå¾Œã«å³å´ã§ä¿å­˜</p>
                    <p class="text-xs text-brand-100 md:hidden block">å…¥åŠ›å¾Œã«ã€Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€ã¸</p>
                </div>
                <button onclick="resetForm()" class="text-xs bg-brand-800 px-3 py-1 rounded hover:bg-brand-900 transition border border-brand-500">ãƒªã‚»ãƒƒãƒˆ</button>
            </div>

            <div class="flex-1 overflow-y-auto p-6 custom-scroll space-y-8 pb-20 md:pb-6">
                
                <!-- 1. Customer Info -->
                <section>
                    <h3 class="text-sm font-bold text-brand-600 uppercase tracking-wide mb-3 border-b border-brand-100 pb-1">â‘  åŸºæœ¬æƒ…å ±</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold mb-1 text-gray-500">ãŠå®¢æ§˜å</label>
                            <input type="text" id="customerName" class="w-full border border-gray-300 rounded p-2 text-sm focus:ring-2 focus:ring-brand-500 outline-none" placeholder="ä¾‹: å±±ç”° èŠ±å­" oninput="updateUI()">
                        </div>
                        <div>
                            <label class="block text-xs font-bold mb-1 text-gray-500">æ¥åº—æ—¥</label>
                            <input type="date" id="visitDate" class="w-full border border-gray-300 rounded p-2 text-sm focus:ring-2 focus:ring-brand-500 outline-none" oninput="updateUI()">
                        </div>
                    </div>
                </section>

                <!-- 2. Today's Menu -->
                <section>
                    <h3 class="text-sm font-bold text-brand-600 uppercase tracking-wide mb-3 border-b border-brand-100 pb-1">â‘¡ æœ¬æ—¥ã®æ–½è¡“ (é¸æŠ)</h3>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <label class="flex items-center space-x-2 cursor-pointer bg-brand-50 p-2 rounded border border-transparent hover:border-brand-200 transition"><input type="checkbox" class="menu-check form-checkbox text-brand-600 accent-brand-600" value="éª¨ç›¤çŸ¯æ­£" checked onchange="updateUI()"> <span>éª¨ç›¤çŸ¯æ­£</span></label>
                        <label class="flex items-center space-x-2 cursor-pointer bg-brand-50 p-2 rounded border border-transparent hover:border-brand-200 transition"><input type="checkbox" class="menu-check form-checkbox text-brand-600 accent-brand-600" value="å§¿å‹¢çŸ¯æ­£" checked onchange="updateUI()"> <span>å§¿å‹¢çŸ¯æ­£</span></label>
                        <label class="flex items-center space-x-2 cursor-pointer bg-brand-50 p-2 rounded border border-transparent hover:border-brand-200 transition"><input type="checkbox" class="menu-check form-checkbox text-brand-600 accent-brand-600" value="å°é¡”çŸ¯æ­£" onchange="updateUI()"> <span>å°é¡”çŸ¯æ­£</span></label>
                        <label class="flex items-center space-x-2 cursor-pointer bg-brand-50 p-2 rounded border border-transparent hover:border-brand-200 transition"><input type="checkbox" class="menu-check form-checkbox text-brand-600 accent-brand-600" value="ã»ãã—" onchange="updateUI()"> <span>ã»ãã—</span></label>
                    </div>
                </section>

                <!-- 3. Current State (Chart Data) -->
                <section>
                    <h3 class="text-sm font-bold text-brand-600 uppercase tracking-wide mb-3 border-b border-brand-100 pb-1">â‘¢ ç¾åœ¨ã®çŠ¶æ…‹ãƒ»èª²é¡Œ (1-5ç‚¹)</h3>
                    <p class="text-xs text-gray-500 mb-2">â€»æ•°å€¤ã‚’å¤‰æ›´ã™ã‚‹ã¨ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã«åæ˜ ã•ã‚Œã¾ã™</p>
                    <div class="space-y-3 bg-white p-2">
                        <div class="flex justify-between items-center">
                            <label class="text-sm w-24 text-gray-600">å§¿å‹¢ãƒ»ãƒãƒ©ãƒ³ã‚¹</label>
                            <input type="range" id="scorePosture" min="1" max="5" step="1" value="3" class="w-full mx-2 accent-brand-500" oninput="updateChartData()">
                            <span id="valPosture" class="text-sm font-bold w-4 text-center text-brand-600">3</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <label class="text-sm w-24 text-gray-600">æŸ”è»Ÿæ€§ãƒ»å¯å‹•åŸŸ</label>
                            <input type="range" id="scoreFlex" min="1" max="5" step="1" value="2" class="w-full mx-2 accent-brand-500" oninput="updateChartData()">
                            <span id="valFlex" class="text-sm font-bold w-4 text-center text-brand-600">2</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <label class="text-sm w-24 text-gray-600">å·¡ã‚Šãƒ»ä»£è¬</label>
                            <input type="range" id="scoreFlow" min="1" max="5" step="1" value="3" class="w-full mx-2 accent-brand-500" oninput="updateChartData()">
                            <span id="valFlow" class="text-sm font-bold w-4 text-center text-brand-600">3</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <label class="text-sm w-24 text-gray-600">ç­‹å‡ºåŠ›ãƒ»å®‰å®š</label>
                            <input type="range" id="scoreMuscle" min="1" max="5" step="1" value="4" class="w-full mx-2 accent-brand-500" oninput="updateChartData()">
                            <span id="valMuscle" class="text-sm font-bold w-4 text-center text-brand-600">4</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <label class="text-sm w-24 text-gray-600">é¡”ãƒ»é ­éƒ¨ã®è»½ã•</label>
                            <input type="range" id="scoreFace" min="1" max="5" step="1" value="3" class="w-full mx-2 accent-brand-500" oninput="updateChartData()">
                            <span id="valFace" class="text-sm font-bold w-4 text-center text-brand-600">3</span>
                        </div>
                    </div>
                </section>

                <!-- 4. Message & Goal -->
                <section>
                    <h3 class="text-sm font-bold text-brand-600 uppercase tracking-wide mb-3 border-b border-brand-100 pb-1">â‘£ ã‚³ãƒ¡ãƒ³ãƒˆ / æ¬¡ã®ç›®æ¨™</h3>
                    <div class="mb-3">
                        <label class="block text-xs font-bold mb-1 text-gray-500">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ</label>
                        <select id="msgTemplate" class="w-full border border-gray-300 rounded p-2 text-sm bg-white text-gray-600" onchange="applyTemplate()">
                            <option value="">ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›...</option>
                            <option value="improvement">ã€ç¶™ç¶šã€‘å§¿å‹¢æ”¹å–„ãƒ»ç§°è³›ãƒ‘ã‚¿ãƒ¼ãƒ³</option>
                            <option value="cold">ã€å­£ç¯€ã€‘å†·ãˆãƒ»ã‚€ãã¿ã‚±ã‚¢ãƒ‘ã‚¿ãƒ¼ãƒ³</option>
                            <option value="face">ã€é¡”ã€‘å°é¡”ãƒ»é£Ÿã„ã—ã°ã‚Šã‚±ã‚¢ãƒ‘ã‚¿ãƒ¼ãƒ³</option>
                            <option value="first">ã€åˆå›/åˆæœŸã€‘ç«‹ã¡æ–¹ãƒ»æ„è­˜ä»˜ã‘ãƒ‘ã‚¿ãƒ¼ãƒ³</option>
                        </select>
                    </div>
                    <textarea id="coachComment" class="w-full border border-gray-300 rounded p-2 text-sm h-24 focus:ring-2 focus:ring-brand-500 outline-none resize-none" placeholder="ã“ã“ã«ãŠå®¢æ§˜ã¸ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å…¥åŠ›..." oninput="updateUI()"></textarea>
                </section>

                <!-- 5. Recommended Stretches -->
                <section>
                    <h3 class="text-sm font-bold text-brand-600 uppercase tracking-wide mb-3 border-b border-brand-100 pb-1">â‘¤ å®¿é¡Œã‚¹ãƒˆãƒ¬ãƒƒãƒ</h3>
                    <div id="stretchSelectionArea" class="space-y-4">
                        <!-- Populated by JS -->
                    </div>
                </section>

                <!-- Spacer for mobile scroll -->
                <div class="h-10 md:hidden"></div>

            </div>
        </aside>

        <!-- ========================================== -->
        <!-- RIGHT PANEL: PREVIEW (OUTPUT TARGET)      -->
        <!-- ========================================== -->
        <!-- Added ID, and logic for show/hide on mobile -->
        <main id="panel-preview" class="w-full md:w-1/2 lg:w-7/12 bg-gray-100 h-full overflow-y-auto custom-scroll relative hidden md:block">
            
            <div class="flex flex-col items-center justify-start min-h-full p-4 md:p-8 pb-20">
                
                <!-- DOWNLOAD BUTTON (Sticky position to stay visible) -->
                <div class="sticky top-0 z-50 w-full max-w-[400px] flex justify-end mb-2 pointer-events-none">
                    <div class="pointer-events-auto">
                        <button onclick="downloadImage()" class="flex items-center gap-2 bg-brand-600 text-white px-4 py-2 rounded-full shadow-lg hover:bg-brand-500 hover:shadow-xl transition transform hover:-translate-y-0.5 font-bold text-sm border-2 border-white">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            ç”»åƒã‚’ä¿å­˜
                        </button>
                        <p id="saveMsg" class="text-xs text-brand-600 text-center mt-1 opacity-0 transition bg-white/80 rounded px-1">ä¿å­˜ã—ã¾ã—ãŸï¼</p>
                    </div>
                </div>

                <!-- PHONE CONTAINER (The part to screenshot) -->
                <div id="captureArea" class="bg-white w-full max-w-[400px] shadow-2xl overflow-hidden relative text-gray-800 h-auto" style="min-height: 700px; border-radius: 20px;">
                    
                    <!-- Top Decoration -->
                    <div class="bg-gradient-to-r from-brand-300 to-brand-500 h-3 w-full"></div>

                    <!-- Header -->
                    <div class="p-6 pb-4 text-center bg-brand-50/50">
                        <p class="text-[10px] text-brand-500 font-bold tracking-[0.2em] uppercase mb-1">Personal After Care Sheet</p>
                        <h2 class="text-2xl font-bold text-gray-700 mb-1" id="previewName">æ§˜</h2>
                        <p class="text-xs text-brand-300 font-medium" id="previewDate">2023.00.00</p>
                    </div>

                    <!-- 1. Today's Care (EMPHASIZED) -->
                    <div class="px-6 mb-6">
                        <div class="relative py-4">
                            <div class="absolute inset-0 flex items-center" aria-hidden="true">
                                <div class="w-full border-t border-brand-100"></div>
                            </div>
                            <div class="relative flex justify-center">
                                <span class="px-2 bg-white text-xs font-bold text-brand-400 uppercase tracking-widest">Today's Menu</span>
                            </div>
                        </div>
                        
                        <!-- Emphasized Menu Container -->
                        <div id="previewMenu" class="flex flex-wrap justify-center gap-3">
                            <!-- Badges injected here with stronger styling -->
                        </div>
                    </div>

                    <!-- 2. Body Analysis (Chart) -->
                    <div class="px-6 mb-6">
                        <h4 class="text-xs font-bold text-brand-400 mb-2 text-center tracking-widest uppercase">Body Balance</h4>
                        <div class="bg-brand-50/50 rounded-2xl p-4 chart-wrapper border border-brand-50 shadow-[inset_0_2px_4px_rgba(0,0,0,0.02)]">
                            <!-- Chart Container for Chart.js -->
                            <div class="chart-container" style="position: relative; width: 100%; height: 100%;">
                                <canvas id="bodyChart"></canvas>
                            </div>
                        </div>
                        <div class="mt-3 flex justify-between text-[10px] text-brand-400 px-4">
                            <span>Previous</span>
                            <span>Current</span>
                            <span>Goal</span>
                        </div>
                    </div>

                    <!-- 3. Coach Feedback -->
                    <div class="px-6 mb-8">
                        <h4 class="text-xs font-bold text-brand-400 mb-3 text-center tracking-widest uppercase">Feedback & Goal</h4>
                        <div class="bg-white relative">
                            <!-- Quotation mark decoration -->
                            <span class="absolute -top-2 -left-1 text-4xl text-brand-200 opacity-50 font-serif leading-none">â€œ</span>
                            <p id="previewComment" class="text-sm leading-relaxed text-gray-600 whitespace-pre-wrap pl-6 border-l-2 border-brand-300 py-1">
                                æœ¬æ—¥ã¯æ–½è¡“ãŠç–²ã‚Œæ§˜ã§ã—ãŸã€‚
                                éª¨ç›¤å‘¨ã‚Šã®å‹•ãã¯è‰¯ããªã£ã¦ã„ã¾ã™ï¼æ¬¡å›ã¯è‚©ç”²éª¨å‘¨ã‚Šã‚’ã•ã‚‰ã«åºƒã’ã¦ã„ãã¾ã—ã‚‡ã†ã€‚
                            </p>
                        </div>
                    </div>

                    <!-- 4. Home Work (Stretches) -->
                    <div class="bg-gradient-to-br from-brand-600 to-brand-800 text-white p-6 pb-10 min-h-[220px]">
                        <div class="flex items-center justify-center gap-2 mb-6">
                            <span class="text-lg bg-white/20 w-8 h-8 flex items-center justify-center rounded-full text-white">ğŸ§˜â€â™€ï¸</span>
                            <h4 class="font-bold tracking-[0.2em] text-sm text-brand-100">HOME CARE</h4>
                        </div>
                        
                        <div id="previewStretches" class="space-y-4">
                            <!-- Stretch Cards injected here -->
                        </div>

                        <div class="mt-8 text-center border-t border-white/10 pt-4">
                             <p class="text-[10px] text-brand-200 opacity-90">
                                ç¾ã—ã•ã¯æ—¥ã€…ã®ç©ã¿é‡ã­ã‹ã‚‰âœ¨<br>
                                ã”ä¸æ˜ç‚¹ã¯LINEã«ã¦ã„ã¤ã§ã‚‚ã”ç›¸è«‡ãã ã•ã„ã€‚
                            </p>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <!-- JavaScript Implementation -->
    <script>
        // ==========================================
        // 1. DATA SOURCE
        // ==========================================
        
        const commentTemplates = {
            improvement: "å§¿å‹¢æ”¹å–„ã«å‘ã‘ã¦ç¾åœ¨é ‘å¼µã£ã¦ã„ã¾ã™ãŒã€çŠ¶æ…‹ã¯ã„ã‹ãŒã§ã—ã‚‡ã†ã‹ï¼Ÿ\næœ¬æ—¥ã¯ã€‡ã€‡ã®ä½ç½®ãŒè‰¯ããªã£ã¦ã„ã¾ã™ã€‚å°‘ã—æ„è­˜ã™ã‚‹ã ã‘ã§ã‚‚ã‚ˆã‚Šè¿‘ã¥ã„ã¦ã„ã‘ã¾ã™ã®ã§ã€å¼•ãç¶šãé ‘å¼µã£ã¦ã„ãã¾ã—ã‚‡ã†ï¼",
            cold: "æœ€è¿‘å¯’ã„ã§ã™ã­ã€‚è¶³ã®ã‚€ãã¿ã‚„å†·ãˆã‚’æ„Ÿã˜ã¦è‚©ã«åŠ›ãŒå…¥ã£ã¦ã—ã¾ã„ãŒã¡ã§ã™ã€‚\næœ¬æ—¥ã¯éª¨ç›¤çŸ¯æ­£ã§åœŸå°ã‚’æ•´ãˆã¦å¾ªç’°ã‚’ã‚ˆãã—ã€å§¿å‹¢çŸ¯æ­£ã§å¯å‹•åŸŸã‚’åºƒã’ã¦å·»ãè‚©ã‚’ã‚±ã‚¢ã—ã¾ã—ãŸã€‚ãŠé¢¨å‘‚ä¸ŠãŒã‚Šãªã©ã«ã‚¹ãƒˆãƒ¬ãƒƒãƒã‚’è¡Œã£ã¦ã¿ã¦ãã ã•ã„ã€‚",
            face: "æœ¬æ—¥ã¯å§¿å‹¢çŸ¯æ­£ã§è‚©ç”²éª¨ã€è‚©ã¾ã‚ã‚Šã‚’å‹•ã‹ã—ã¦å‘¼å¸ã‚’ã—ã‚„ã™ãã—ã€å°é¡”çŸ¯æ­£ã§é£Ÿã„ã—ã°ã‚Šã‚„å´é ­ç­‹ãªã©ã‚’å¼›ã‚ã¦ãŠèº«ä½“ã‚’ã‚¹ãƒƒã‚­ãƒªã•ã›ã¾ã—ãŸï¼\né¡”å‘¨ã‚Šã®ç·Šå¼µãŒå–ã‚Œã‚‹ã¨ç¡çœ ã®è³ªã‚‚ä¸ŠãŒã‚Šã¾ã™ã€‚",
            first: "ç«‹ã¡æ–¹ï¼ˆåº§ã‚Šæ–¹ã€æ­©ãæ–¹ï¼‰ã¯ã”è‡ªå®…ã‚„è·å ´ã§ã‚‚æ„è­˜ã§ãã¦ã„ã¾ã™ã‹ï¼Ÿ\nã¾ãšã¯ã”è‡ªèº«ã§ã€Œæ°—ã¥ã„ãŸæ™‚ã«ç›´ã™ã€ç¯„å›²ã§å¤§ä¸ˆå¤«ã§ã™ã€‚éª¨ç›¤ã®ä½¿ã„æ–¹ã€è‚©é¦–ã®ä½ç½®ãªã©ã€æ¬¡å›ã¾ãŸãƒã‚§ãƒƒã‚¯ã•ã›ã¦ã„ãŸã ãã¾ã™ã­ã€‚"
        };

        const stretchData = {
            posture: [
                {
                    id: "p1",
                    title: "èƒ¸ç­‹ãƒ»äºŒé ­ç­‹ã‚¹ãƒˆãƒ¬ãƒƒãƒ",
                    icon: "ğŸ‘",
                    text: "â‘ å£ã®æ¨ªã«ç«‹ã¤ â‘¡å£å´ã®æ‰‹ã‚’æ–œã‚å¾Œã‚ä¸Šã«ã¤ã â‘¢ä½“ã‚’åå¯¾å´ã«å‘ã‘ã¦èƒ¸ã‚„è…•ã‚’ä¼¸ã°ã™ (15ç§’)"
                },
                {
                    id: "p2",
                    title: "å‰é‹¸ç­‹ã‚¹ãƒˆãƒ¬ãƒƒãƒ(å£)",
                    icon: "ğŸ§±",
                    text: "â‘ æ‰‹ã‚’çœŸä¸Šã«ä¼¸ã°ã™ â‘¡ä½“ã‚’å£ã«å¯†ç€ã•ã›ã€æ‰‹ã®ã²ã‚‰ã‚’å‰ã«å‘ã‘ã‚‹ â‘¢è…•ã‚’çœŸä¸Šã«ä¸Šã’ã¦è„‡ã®ä¸‹ã‚’ä¼¸ã°ã™"
                },
                {
                    id: "p3",
                    title: "ä¸Šè…•ä¸‰é ­ç­‹ã‚¹ãƒˆãƒ¬ãƒƒãƒ",
                    icon: "ğŸ’ª",
                    text: "â‘ è‚˜ã‚’å¾Œã«æ›²ã’ã‚‹ â‘¡è…•ã®ä½ç½®ã¯è€³ã‚ˆã‚Šã‚„ã‚„å¾Œã‚ã¸ â‘¢äºŒã®è…•ã‚„è„‡ã‚’ä¼¸ã°ã™"
                },
                {
                    id: "p4",
                    title: "è‚©å›ã—ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚º",
                    icon: "ğŸ”„",
                    text: "â‘ æ‰‹ã‚’è‚©ã«ç½®ã â‘¡å¤§ããå¾Œã‚ã‹ã‚‰å‰ã¸å›ã™ â‘¢åå¯¾å›ã—ã‚‚è¡Œã† (ã‚´ãƒªã‚´ãƒªé³´ã‚‹å ´åˆã¯ã‚†ã£ãã‚Šå‹•ã‹ã™)"
                },
                {
                    id: "p5",
                    title: "å·»ãè‚©ã‚±ã‚¢",
                    icon: "ğŸ¥",
                    text: "â‘ è‚˜ã‚’æ›²ã’ã€ä¸Šè…•ã‚’è„‡ã«ã¤ã‘ã‚‹ â‘¡å‰è…•éƒ¨åˆ†ã ã‘å¾Œã‚å›ã—ã‚’ã™ã‚‹ (å¾Œã‚ã®è‚©å‘¨ã‚Šã«åŠ¹ã„ã¦ã„ã‚Œã°OK)"
                }
            ],
            pelvis: [
                {
                    id: "l1",
                    title: "ãŠå°»ã‚¹ãƒˆãƒ¬ãƒƒãƒ(æ¤…å­)",
                    icon: "ğŸª‘",
                    text: "â‘ æ¤…å­ã«åº§ã‚Šç‰‡è¶³ã‚’ä¸Šã’ã‚‹ â‘¡è¶³é¦–ã‚’åå¯¾ã®è†ä¸Šã«ç½®ã â‘¢èƒŒç­‹ã‚’ä¼¸ã°ã—ä¸ŠåŠèº«ã‚’å‰ã¸å€’ã™"
                },
                {
                    id: "l2",
                    title: "ãŠå°»ã‚¹ãƒˆãƒ¬ãƒƒãƒ(åºŠ)",
                    icon: "ğŸ§˜",
                    text: "â‘ æ¤…å­ã¨åŒã˜è¶³ã®å½¢ã‚’ä½œã‚‹ â‘¡ç«‹ã¦ã¦ã„ã‚‹è†ã‚’è‡ªåˆ†ã®æ–¹ã¸æŠ±ãå¯„ã›ã¦ãŠå°»ã‚’ä¼¸ã°ã™"
                },
                {
                    id: "l3",
                    title: "è£ãƒ¢ãƒ¢ä¼¸ã°ã—",
                    icon: "ğŸ¦¶",
                    text: "â‘ ç‰‡è¶³ã‚’å°ã«ä¹—ã›ã‚‹ â‘¡è†ã‚’ä¼¸ã°ã—è¶³é¦–ã‚’æœ€å¤§ã«æ›²ã’ã‚‹ â‘¢è†ãŒæ›²ãŒã‚‰ãªã„ã‚ˆã†ä½“ã‚’å‰ã«å€’ã™"
                },
                {
                    id: "l4",
                    title: "å†…è…¿ã»ãã—",
                    icon: "ğŸ¦µ",
                    text: "â‘ ã‚ãã‚‰ã®çŠ¶æ…‹ã§å†…è…¿ã‚’è§¦ã‚‹ â‘¡æ‰‹ã®ã²ã‚‰ã§å†…è…¿ã‚’è¦†ã„ã€ä½“é‡ã‚’ã‹ã‘ã¦æŠ¼åœ§ã™ã‚‹"
                }
            ],
            face: [
                {
                    id: "f1",
                    title: "é–éª¨ãƒ»é¦–ã‚¹ãƒˆãƒ¬ãƒƒãƒ",
                    icon: "ğŸ¦¢",
                    text: "â‘ ä¸¡æ‰‹ã§é–éª¨ã‚’ä¸‹ã«å¼•ã â‘¡é¦–ã‚’å¾Œã‚ã¸å€’ã™ â‘¢å£ã‚’ã€Œã‚¦ã€ã®å½¢ã«ã—ã¦15ç§’ã‚­ãƒ¼ãƒ—"
                },
                {
                    id: "f2",
                    title: "å’¬ç­‹ï¼ˆé£Ÿã„ã—ã°ã‚Šï¼‰ã‚±ã‚¢",
                    icon: "ğŸ˜¬",
                    text: "â‘ å™›ã¿ç· ã‚ã‚‹ã¨ç¡¬ããªã‚‹éƒ¨åˆ†(å’¬ç­‹)ã‚’æŒ‡ã§æŠ¼ã•ãˆã‚‹ â‘¡ã‚†ã£ãã‚Šå°åˆ»ã¿ã«æºã‚‰ã—ã¦ç·©ã‚ã‚‹"
                },
                {
                    id: "f3",
                    title: "è€³å›ã—",
                    icon: "ğŸ‘‚",
                    text: "â‘ è€³ã‚’æŒã¤ â‘¡æ¨ªã«ã‚†ã£ãã‚Šå¼•ã£å¼µã£ãŸã‚Šã€å›ã—ãŸã‚Šã™ã‚‹ (é¡”ã®è¡€æµUP)"
                },
                {
                    id: "f4",
                    title: "å¾Œé ­ä¸‹ç­‹ãƒªãƒªãƒ¼ã‚¹",
                    icon: "ğŸ›Œ",
                    text: "â‘ ä»°å‘ã‘ã§å¯ã‚‹ â‘¡å¾Œé ­éƒ¨ã®ãã¼ã¿(å¾Œé ­ä¸‹ç­‹)ã«æ‰‹ã‚’ç½®ã â‘¢é¡ã‚’å°‘ã—ä¸Šã’ã‚†ã£ãã‚Šæ·±å‘¼å¸"
                }
            ]
        };

        // ==========================================
        // 2. INITIALIZATION
        // ==========================================
        
        let myChart = null;

        window.onload = function() {
            // Set Date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('visitDate').value = today;
            
            // Render Stretches in Panel
            renderStretchSelection();

            // Initialize Chart
            initChart();

            // Initial UI Update
            updateUI();
        };

        // ==========================================
        // 3. LOGIC & FUNCTIONS
        // ==========================================

        // --- Tab Switching Logic (Mobile) ---
        function switchTab(tabName) {
            const editPanel = document.getElementById('panel-edit');
            const previewPanel = document.getElementById('panel-preview');
            const editTabBtn = document.getElementById('tab-edit');
            const previewTabBtn = document.getElementById('tab-preview');

            if (tabName === 'edit') {
                // Show Edit, Hide Preview
                editPanel.classList.remove('hidden');
                previewPanel.classList.add('hidden');
                
                // Style Tabs
                editTabBtn.classList.replace('text-gray-400', 'text-brand-600');
                editTabBtn.classList.replace('border-transparent', 'border-brand-500');
                editTabBtn.classList.add('bg-brand-50');
                
                previewTabBtn.classList.replace('text-brand-600', 'text-gray-400');
                previewTabBtn.classList.replace('border-brand-500', 'border-transparent');
                previewTabBtn.classList.remove('bg-brand-50');

            } else {
                // Hide Edit, Show Preview
                editPanel.classList.add('hidden');
                previewPanel.classList.remove('hidden');
                
                // Style Tabs
                previewTabBtn.classList.replace('text-gray-400', 'text-brand-600');
                previewTabBtn.classList.replace('border-transparent', 'border-brand-500');
                previewTabBtn.classList.add('bg-brand-50');
                
                editTabBtn.classList.replace('text-brand-600', 'text-gray-400');
                editTabBtn.classList.replace('border-brand-500', 'border-transparent');
                editTabBtn.classList.remove('bg-brand-50');
                
                // Refresh chart since canvas might have resized while hidden
                if (myChart) myChart.resize();
            }
        }

        // Ensure Reset for Desktop on Resize
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 768) { // md breakpoint
                document.getElementById('panel-edit').classList.remove('hidden');
                document.getElementById('panel-preview').classList.remove('hidden');
            } else {
                // Revert to current tab state logic if shrinking back to mobile
                // For simplicity, default to edit on resize to mobile
                switchTab('edit');
            }
        });


        function renderStretchSelection() {
            const container = document.getElementById('stretchSelectionArea');
            let html = '';

            const createCategory = (key, label, colorClass) => {
                let items = stretchData[key].map(s => `
                    <label class="flex items-start space-x-2 p-2 rounded hover:bg-brand-50 cursor-pointer text-xs border border-transparent hover:border-brand-100 transition">
                        <input type="checkbox" class="stretch-check mt-1 form-checkbox text-brand-600 rounded focus:ring-brand-500 accent-brand-500" value="${key}-${s.id}" onchange="updateUI()">
                        <div>
                            <span class="font-bold text-gray-700 block flex items-center gap-1">${s.icon} ${s.title}</span>
                            <span class="text-[10px] text-gray-400 truncate block mt-0.5">${s.text.substring(0, 30)}...</span>
                        </div>
                    </label>
                `).join('');

                return `
                    <details class="group bg-white border border-brand-100 rounded-lg open:shadow-sm" open>
                        <summary class="p-3 cursor-pointer font-bold text-xs text-brand-600 bg-brand-50 rounded-t-lg group-open:border-b border-brand-100 flex justify-between items-center transition hover:bg-brand-100">
                            ${label}
                            <span class="text-brand-400 text-[10px] transition-transform group-open:rotate-180">â–¼</span>
                        </summary>
                        <div class="p-2 grid grid-cols-1 gap-1">
                            ${items}
                        </div>
                    </details>
                `;
            };

            html += createCategory('posture', 'å§¿å‹¢ãƒ»ä¸ŠåŠèº«', '');
            html += createCategory('pelvis', 'éª¨ç›¤ãƒ»ä¸‹åŠèº«', '');
            html += createCategory('face', 'é¡”ãƒ»é¦–ãƒ»å‘¼å¸', '');

            container.innerHTML = html;
        }

        function applyTemplate() {
            const key = document.getElementById('msgTemplate').value;
            const textarea = document.getElementById('coachComment');
            if (key && commentTemplates[key]) {
                textarea.value = commentTemplates[key];
                updateUI();
            }
        }

        function initChart() {
            const ctx = document.getElementById('bodyChart').getContext('2d');
            
            myChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['å§¿å‹¢', 'æŸ”è»Ÿæ€§', 'å¾ªç’°', 'ç­‹åŠ›', 'é¡”ãƒ»é ­'],
                    datasets: [{
                        label: 'Condition',
                        data: [3, 2, 3, 4, 3],
                        // Updated for Green Theme
                        backgroundColor: 'rgba(108, 168, 138, 0.4)', // brand-500 with opacity
                        borderColor: '#6ca88a', // brand-500
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#52856d', // brand-600
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#345244',
                        borderWidth: 2,
                        pointRadius: 3
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    scales: {
                        r: {
                            angleLines: { color: '#e1efe7' }, // brand-100
                            grid: { color: '#f2f8f5' }, // brand-50
                            pointLabels: {
                                font: {
                                    size: 10,
                                    family: "'Zen Kaku Gothic New', sans-serif",
                                    weight: 'bold'
                                },
                                color: '#52856d' // brand-600
                            },
                            suggestedMin: 0,
                            suggestedMax: 5,
                            ticks: {
                                display: false,
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    }
                }
            });
        }

        function updateChartData() {
            const s1 = document.getElementById('scorePosture');
            const s2 = document.getElementById('scoreFlex');
            const s3 = document.getElementById('scoreFlow');
            const s4 = document.getElementById('scoreMuscle');
            const s5 = document.getElementById('scoreFace');

            document.getElementById('valPosture').innerText = s1.value;
            document.getElementById('valFlex').innerText = s2.value;
            document.getElementById('valFlow').innerText = s3.value;
            document.getElementById('valMuscle').innerText = s4.value;
            document.getElementById('valFace').innerText = s5.value;

            if (myChart) {
                myChart.data.datasets[0].data = [s1.value, s2.value, s3.value, s4.value, s5.value];
                myChart.update();
            }
        }

        function updateUI() {
            // 1. Name & Date
            const name = document.getElementById('customerName').value || 'ãŠå®¢æ§˜';
            const dateVal = document.getElementById('visitDate').value;
            
            document.getElementById('previewName').innerText = name + (name.includes('æ§˜') ? '' : ' æ§˜');
            document.getElementById('previewDate').innerText = dateVal.replace(/-/g, '.');

            // 2. Menu Badges (Emphasized)
            const menuContainer = document.getElementById('previewMenu');
            menuContainer.innerHTML = '';
            const menuChecks = document.querySelectorAll('.menu-check:checked');
            if (menuChecks.length === 0) {
                menuContainer.innerHTML = '<span class="text-xs text-brand-300">æ–½è¡“å†…å®¹ãªã—</span>';
            } else {
                menuChecks.forEach(cb => {
                    const span = document.createElement('div');
                    // Stronger visual emphasis for tags
                    span.className = 'px-4 py-2 bg-brand-100 text-brand-800 text-sm rounded-lg border-2 border-brand-200 font-bold shadow-sm flex items-center gap-2';
                    span.innerHTML = `<span class="text-brand-500">âœ”</span> ${cb.value}`;
                    menuContainer.appendChild(span);
                });
            }

            // 3. Comment
            const comment = document.getElementById('coachComment').value;
            document.getElementById('previewComment').innerText = comment || "æœ¬æ—¥ã¯ã”æ¥åº—ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚\nãŠä¼ãˆã—ãŸã‚¹ãƒˆãƒ¬ãƒƒãƒã‚’ç„¡ç†ã®ãªã„ç¯„å›²ã§è¡Œã£ã¦ã¿ã¦ãã ã•ã„ã€‚";

            // 4. Stretches
            const stretchContainer = document.getElementById('previewStretches');
            stretchContainer.innerHTML = '';
            const stretchChecks = document.querySelectorAll('.stretch-check:checked');
            
            if (stretchChecks.length === 0) {
                stretchContainer.innerHTML = '<p class="text-xs text-brand-100 text-center opacity-70">æœ¬æ—¥ã®ç‰¹åˆ¥ãªå®¿é¡Œã¯ã‚ã‚Šã¾ã›ã‚“<br>æ°´åˆ†ã‚’ã—ã£ã‹ã‚Šæ‘‚ã£ã¦ä¼‘ã¿ã¾ã—ã‚‡ã†</p>';
            } else {
                stretchChecks.forEach(cb => {
                    const [cat, id] = cb.value.split('-');
                    const data = stretchData[cat].find(s => s.id === id);
                    if (data) {
                        const div = document.createElement('div');
                        div.className = 'bg-white/10 backdrop-blur-md p-4 rounded-xl border border-white/30 shadow-sm';
                        div.innerHTML = `
                            <div class="flex items-center gap-3 mb-2 border-b border-white/20 pb-2">
                                <span class="text-xl bg-white text-brand-600 w-8 h-8 flex items-center justify-center rounded-full shadow-sm">${data.icon}</span>
                                <h5 class="font-bold text-sm text-white tracking-wide">${data.title}</h5>
                            </div>
                            <p class="text-xs text-brand-50 leading-relaxed opacity-95">
                                ${data.text}
                            </p>
                        `;
                        stretchContainer.appendChild(div);
                    }
                });
            }
        }

        function resetForm() {
            if(confirm('å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                document.getElementById('customerName').value = '';
                document.getElementById('coachComment').value = '';
                document.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked = false);
                document.querySelectorAll('input[type="range"]').forEach(r => r.value = 3);
                updateChartData();
                updateUI();
            }
        }

        // ==========================================
        // DOWNLOAD IMAGE FUNCTION
        // ==========================================
        function downloadImage() {
            const element = document.getElementById('captureArea');
            const msg = document.getElementById('saveMsg');
            
            // Visual Feedback
            msg.style.opacity = '1';
            msg.innerText = 'ç”Ÿæˆä¸­...';

            html2canvas(element, {
                scale: 2, // High resolution (Retina)
                backgroundColor: '#ffffff', // Ensure white background
                useCORS: true // Allow loading cross-origin images if added later
            }).then(canvas => {
                // Trigger Download
                const link = document.createElement('a');
                const name = document.getElementById('customerName').value || 'Customer';
                const date = document.getElementById('visitDate').value || 'Date';
                
                link.download = `AfterCare_${name}_${date}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();

                // Finish Feedback
                msg.innerText = 'ä¿å­˜ã—ã¾ã—ãŸï¼';
                setTimeout(() => {
                    msg.style.opacity = '0';
                }, 2000);
            }).catch(err => {
                console.error(err);
                msg.innerText = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
            });
        }

    </script>
</body>
</html>
